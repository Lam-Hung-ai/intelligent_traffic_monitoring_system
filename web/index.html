<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* ƒê·ªãnh d·∫°ng giao di·ªán c∆° b·∫£n v√† t·ªëi ∆∞u kh√¥ng gian hi·ªÉn th·ªã bi·ªÉu ƒë·ªì */
        body { background-color: #f4f6f9; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .chart-container { position: relative; height: 60vh; width: 100%; }
        .status-badge { font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold text-primary">üöó Traffic Monitoring System</h2>
            <p class="text-muted">Gi√°m s√°t l∆∞u l∆∞·ª£ng v√† d·ª± b√°o giao th√¥ng theo th·ªùi gian th·ª±c</p>
        </div>
        <div class="col-md-4 text-end">
            <label for="cameraSelect" class="form-label fw-bold">Ch·ªçn Camera:</label>
            <select id="cameraSelect" class="form-select form-select-lg">
                <option value="" disabled selected>ƒêang t·∫£i danh s√°ch...</option>
            </select>
        </div>
    </div>

    <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h5 id="chartTitle" class="card-title mb-0">D·ªØ li·ªáu l∆∞u l∆∞·ª£ng</h5>
                <small id="locationName" class="text-muted">V·ªã tr√≠: ---</small>
            </div>
            <span id="lastUpdated" class="badge bg-secondary status-badge">C·∫≠p nh·∫≠t: ---</span>
        </div>
        
        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>



<script>
    const API_BASE = "http://localhost:8000"; 
    let myChart = null;
    let refreshInterval = null;

    /**
     * Kh·ªüi t·∫°o c·∫•u h√¨nh bi·ªÉu ƒë·ªì ƒëa tr·ª•c th·ªùi gian.
     * Thi·∫øt l·∫≠p hai t·∫≠p d·ªØ li·ªáu (Dataset): 
     * - Th·ª±c t·∫ø: ƒê∆∞·ªùng li·ªÅn n√©t m√†u xanh.
     * - D·ª± b√°o: ƒê∆∞·ªùng n√©t ƒë·ª©t m√†u ƒë·ªè ƒë·ªÉ ph√¢n bi·ªát tr·ª±c quan.
     */
    function initChart() {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'L·ªãch s·ª≠ (Th·ª±c t·∫ø)',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)', 
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderWidth: 2,
                        tension: 0.3, 
                        pointRadius: 3
                    },
                    {
                        label: 'D·ª± b√°o (AI Prediction)',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)', 
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        borderDash: [5, 5], 
                        tension: 0.3,
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time', 
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'HH:mm dd/MM',
                            displayFormats: { minute: 'HH:mm' }
                        },
                        title: { display: true, text: 'Th·ªùi gian' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'S·ªë l∆∞·ª£ng ph∆∞∆°ng ti·ªán' }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { mode: 'index', intersect: false }
                }
            }
        });
    }

    /**
     * Truy v·∫•n danh s√°ch camera kh·∫£ d·ª•ng t·ª´ Backend.
     * T·ª± ƒë·ªông ƒëi·ªÅu h∆∞·ªõng d·ªØ li·ªáu khi load trang b·∫±ng c√°ch ch·ªçn camera m·∫∑c ƒë·ªãnh ƒë·∫ßu ti√™n.
     */
    async function loadCameras() {
        try {
            const res = await fetch(`${API_BASE}/cameras`);
            if (!res.ok) throw new Error("Connection Error");
            
            const data = await res.json();
            const select = document.getElementById('cameraSelect');
            select.innerHTML = ''; 

            const cams = data.details || [];
            if (cams.length === 0) {
                select.innerHTML = '<option>Kh√¥ng c√≥ camera kh·∫£ d·ª•ng</option>';
                return;
            }

            cams.forEach((cam, index) => {
                const option = document.createElement('option');
                option.value = cam.id;
                option.text = `${cam.id} - ${cam.location}`; 
                select.appendChild(option);
                
                if (index === 0) {
                    select.value = cam.id;
                    fetchData(cam.id);
                }
            });
        } catch (err) {
            console.error("Load Cameras Failed:", err);
            document.getElementById('cameraSelect').innerHTML = '<option>M·∫•t k·∫øt n·ªëi server</option>';
        }
    }

    /**
     * L·∫•y d·ªØ li·ªáu chi ti·∫øt (L·ªãch s·ª≠ + D·ª± b√°o) cho m·ªôt camera c·ª• th·ªÉ.
     * √Ånh x·∫° d·ªØ li·ªáu th√¥ t·ª´ API sang t·ªça ƒë·ªô {x, y} ƒë·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i bi·ªÉu ƒë·ªì m√† kh√¥ng c·∫ßn kh·ªüi t·∫°o l·∫°i.
     */
    async function fetchData(camId) {
        try {
            const res = await fetch(`${API_BASE}/traffic/${camId}`);
            if (!res.ok) throw new Error("No Data");
            const data = await res.json();

            // ƒê·ªìng b·ªô th√¥ng tin UI v·ªõi camera ƒëang truy v·∫•n
            document.getElementById('chartTitle').innerText = `L∆∞u l∆∞·ª£ng: ${data.cam_id}`;
            document.getElementById('locationName').innerText = `V·ªã tr√≠: ${data.location}`;
            document.getElementById('lastUpdated').innerText = `C·∫≠p nh·∫≠t: ${new Date().toLocaleTimeString()}`;

            // Chu·∫©n h√≥a t·∫≠p d·ªØ li·ªáu l·ªãch s·ª≠ t·ª´ API cho tr·ª•c th·ªùi gian c·ªßa Chart.js
            const historyPoints = data.history.map(item => ({
                x: item.end_time, 
                y: item.avg_traffic_volume
            }));

            // Chu·∫©n h√≥a t·∫≠p d·ªØ li·ªáu d·ª± b√°o t·ª´ m√¥ h√¨nh AI cho tr·ª•c th·ªùi gian
            const forecastPoints = data.forecast.map(item => ({
                x: item.prediction_timestamp,
                y: item.predicted_volume
            }));

            // ƒê·∫©y d·ªØ li·ªáu m·ªõi v√†o bi·ªÉu ƒë·ªì v√† th·ª±c hi·ªán render l·∫°i
            myChart.data.datasets[0].data = historyPoints;
            myChart.data.datasets[1].data = forecastPoints;
            myChart.update(); 

        } catch (err) {
            console.error("Fetch Data Error:", err);
        }
    }

    // ƒêƒÉng k√Ω s·ª± ki·ªán thay ƒë·ªïi l·ª±a ch·ªçn camera ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu t∆∞∆°ng ·ª©ng
    document.getElementById('cameraSelect').addEventListener('change', (e) => {
        fetchData(e.target.value);
    });

    // Thi·∫øt l·∫≠p chu k·ª≥ t·ª± ƒë·ªông c·∫≠p nh·∫≠t (Polling) m·ªói 60 gi√¢y ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu lu√¥n m·ªõi nh·∫•t
    window.onload = () => {
        initChart();
        loadCameras();

        setInterval(() => {
            const currentCam = document.getElementById('cameraSelect').value;
            if (currentCam) fetchData(currentCam);
        }, 60000);
    };

</script>

</body>
</html>