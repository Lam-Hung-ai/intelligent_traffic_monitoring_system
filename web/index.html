<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .card { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: none; }
        .chart-container { position: relative; height: 60vh; width: 100%; }
        .status-badge { font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold text-primary">üöó Traffic Monitoring System</h2>
            <p class="text-muted">Gi√°m s√°t l∆∞u l∆∞·ª£ng v√† d·ª± b√°o giao th√¥ng theo th·ªùi gian th·ª±c</p>
        </div>
        <div class="col-md-4 text-end">
            <label for="cameraSelect" class="form-label fw-bold">Ch·ªçn Camera:</label>
            <select id="cameraSelect" class="form-select form-select-lg">
                <option value="" disabled selected>ƒêang t·∫£i danh s√°ch...</option>
            </select>
        </div>
    </div>

    <div class="card p-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h5 id="chartTitle" class="card-title mb-0">D·ªØ li·ªáu l∆∞u l∆∞·ª£ng</h5>
                <small id="locationName" class="text-muted">V·ªã tr√≠: ---</small>
            </div>
            <span id="lastUpdated" class="badge bg-secondary status-badge">C·∫≠p nh·∫≠t: ---</span>
        </div>
        
        <div class="chart-container">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
    const API_BASE = "http://localhost:8000"; // ƒê·ªïi port n·∫øu c·∫ßn
    let myChart = null;
    let refreshInterval = null;

    // 1. Kh·ªüi t·∫°o Chart
    function initChart() {
        const ctx = document.getElementById('trafficChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'L·ªãch s·ª≠ (Th·ª±c t·∫ø)',
                        data: [],
                        borderColor: 'rgba(54, 162, 235, 1)', // M√†u Xanh
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderWidth: 2,
                        tension: 0.3, // ƒê·ªô cong m·ªÅm m·∫°i
                        pointRadius: 3
                    },
                    {
                        label: 'D·ª± b√°o (AI Prediction)',
                        data: [],
                        borderColor: 'rgba(255, 99, 132, 1)', // M√†u ƒê·ªè
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        borderDash: [5, 5], // N√©t ƒë·ª©t th·ªÉ hi·ªán d·ª± ƒëo√°n
                        tension: 0.3,
                        pointRadius: 3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time', // Tr·ª•c X l√† th·ªùi gian
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'HH:mm dd/MM',
                            displayFormats: {
                                minute: 'HH:mm'
                            }
                        },
                        title: { display: true, text: 'Th·ªùi gian' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'S·ªë l∆∞·ª£ng ph∆∞∆°ng ti·ªán' }
                    }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                }
            }
        });
    }

    // 2. Load danh s√°ch Camera
    async function loadCameras() {
        try {
            const res = await fetch(`${API_BASE}/cameras`);
            if (!res.ok) throw new Error("L·ªói k·∫øt n·ªëi API cameras");
            
            const data = await res.json();
            const select = document.getElementById('cameraSelect');
            
            select.innerHTML = ''; // X√≥a c√°c option c≈© (nh∆∞ 'ƒêang t·∫£i...')
            
            // ∆Øu ti√™n s·ª≠ d·ª•ng data.details v√¨ n√≥ ch·ª©a location chu·∫©n t·ª´ Config
            const cams = data.details || [];

            if (cams.length === 0) {
                const option = document.createElement('option');
                option.text = "Kh√¥ng t√¨m th·∫•y Camera n√†o trong Config";
                select.appendChild(option);
                return;
            }

            cams.forEach((cam, index) => {
                const option = document.createElement('option');
                option.value = cam.id;
                // Hi·ªÉn th·ªã ƒë·∫πp: "cam_000 - Chuong_Trinh"
                option.text = `${cam.id} - ${cam.location}`; 
                select.appendChild(option);
                
                // T·ª± ƒë·ªông ch·ªçn camera ƒë·∫ßu ti√™n v√† t·∫£i d·ªØ li·ªáu ngay
                if (index === 0) {
                    select.value = cam.id;
                    fetchData(cam.id);
                }
            });
        } catch (err) {
            console.error("L·ªói load cameras:", err);
            const select = document.getElementById('cameraSelect');
            select.innerHTML = '<option>M·∫•t k·∫øt n·ªëi t·ªõi Server</option>';
        }
    }
    // 3. L·∫•y d·ªØ li·ªáu v√† v·∫Ω l√™n Chart
    async function fetchData(camId) {
        try {
            const res = await fetch(`${API_BASE}/traffic/${camId}`);
            if (!res.ok) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu");
            const data = await res.json();

            // C·∫≠p nh·∫≠t th√¥ng tin text
            document.getElementById('chartTitle').innerText = `L∆∞u l∆∞·ª£ng: ${data.cam_id}`;
            document.getElementById('locationName').innerText = `V·ªã tr√≠: ${data.location}`;
            document.getElementById('lastUpdated').innerText = `C·∫≠p nh·∫≠t: ${new Date().toLocaleTimeString()}`;

            // --- X·ª¨ L√ù D·ªÆ LI·ªÜU CHART ---
            
            // 1. History Data: Map v·ªÅ d·∫°ng {x: th·ªùi gian, y: gi√° tr·ªã}
            const historyPoints = data.history.map(item => ({
                x: item.end_time, // Tr·ª•c X d√πng end_time
                y: item.avg_traffic_volume
            }));

            // 2. Forecast Data
            const forecastPoints = data.forecast.map(item => ({
                x: item.prediction_timestamp,
                y: item.predicted_volume
            }));

            // C·∫≠p nh·∫≠t v√†o Chart
            myChart.data.datasets[0].data = historyPoints;
            myChart.data.datasets[1].data = forecastPoints;
            
            myChart.update(); // V·∫Ω l·∫°i

        } catch (err) {
            console.error(err);
        }
    }

    // --- S·ª∞ KI·ªÜN ---

    // Khi ƒë·ªïi camera
    document.getElementById('cameraSelect').addEventListener('change', (e) => {
        fetchData(e.target.value);
    });

    // Kh·ªüi ch·∫°y ban ƒë·∫ßu
    window.onload = () => {
        initChart();
        loadCameras();

        // T·ª± ƒë·ªông refresh m·ªói 60 gi√¢y
        setInterval(() => {
            const currentCam = document.getElementById('cameraSelect').value;
            if (currentCam) fetchData(currentCam);
        }, 60000);
    };

</script>

</body>
</html>